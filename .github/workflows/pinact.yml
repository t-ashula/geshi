name: Pin Actions

on:
  pull_request:
    paths:
      - ".github/workflows/**"
  push:
    branches:
      - master
    paths:
      - ".github/workflows/**"

permissions:
  contents: read

jobs:
  pinact:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

      - name: Setup Go
        uses: actions/setup-go@0a12ed9d6a96ab950c8f026ed9f722fe0da7ef32 # v5.0.2
        with:
          go-version: "1.21"

      - name: Install pinact
        run: go install github.com/suzuki-shunsuke/pinact/cmd/pinact@latest

      - name: Check if actions are pinned
        run: |
          echo "Checking if GitHub Actions are pinned to commit SHA..."

          # Find all workflow files
          find .github/workflows -name "*.yml" -o -name "*.yaml" | while read -r file; do
            echo "Checking $file..."
            if ! pinact run "$file"; then
              echo "❌ $file contains unpinned actions"
              exit 1
            else
              echo "✅ $file - all actions are properly pinned"
            fi
          done

          echo "All workflow files have been checked successfully!"

      - name: Generate pinned versions (on failure)
        if: failure()
        run: |
          echo "Generating pinned versions for unpinned actions..."
          find .github/workflows -name "*.yml" -o -name "*.yaml" | while read -r file; do
            echo "Processing $file..."
            pinact run --update "$file" || true
          done

          echo ""
          echo "📋 Suggested fixes:"
          echo "The following files contain unpinned actions. Please update them manually:"
          find .github/workflows -name "*.yml" -o -name "*.yaml" | while read -r file; do
            if ! pinact run "$file" >/dev/null 2>&1; then
              echo "- $file"
            fi
          done
